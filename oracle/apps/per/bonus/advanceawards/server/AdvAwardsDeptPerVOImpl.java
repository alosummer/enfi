package cux.oracle.apps.per.bonus.advanceawards.server;

import java.text.SimpleDateFormat;

import java.util.Date;

import oracle.apps.fnd.framework.server.OAViewObjectImpl;

import oracle.jbo.Row;
import oracle.jbo.RowSetIterator;
// ---------------------------------------------------------------------
// ---    File generated by Oracle ADF Business Components Design Time.
// ---    Custom code may be added to this class.
// ---    Warning: Do not modify method signatures of generated methods.
// ---------------------------------------------------------------------
public class AdvAwardsDeptPerVOImpl extends OAViewObjectImpl {
    /**This is the default constructor (do not remove)
     */
    public AdvAwardsDeptPerVOImpl() {
    }

    public void appendSQL(String bonusType, String distDate, int deptOrgID) {
        if (bonusType != null && !"".equals(bonusType) && distDate != null && 
            !"".equals(distDate) && deptOrgID != 0) {
            Date today = new Date();
            SimpleDateFormat df = new SimpleDateFormat("yyyy-MM");
            String strDate = df.format(today);
            if (strDate.equals(distDate)) {
                setWhereClause("DISTRIBUTION_STATUS = '预保存' AND TYPE_NAME = :1 AND DISTRIBUTION_DATE = TO_DATE(:2, 'yyyy-mm') AND ORGANIZATION_ID = :3 ");
                setWhereClauseParams(null);
                setWhereClauseParam(0, bonusType);
                setWhereClauseParam(1, distDate);
                setWhereClauseParam(2, deptOrgID);
                executeQuery();
                if (this.getRowCount() == 0) {
                    setWhereClause("DISTRIBUTION_STATUS = '已提交' AND TYPE_NAME = :1 AND DISTRIBUTION_DATE = ADD_MONTHS(TO_DATE(:2, 'yyyy-mm'), -1) AND ORGANIZATION_ID = :3 ");
                    setWhereClauseParams(null);
                    setWhereClauseParam(0, bonusType);
                    setWhereClauseParam(1, distDate);
                    setWhereClauseParam(2, deptOrgID);
                    executeQuery();
                    int rowCount = this.getRowCount();
                    RowSetIterator deptPerIter = 
                        this.createRowSetIterator("deptPerIter");
                    deptPerIter.setRangeStart(0);
                    deptPerIter.setRangeSize(rowCount);
                    for (int i = 0; i < rowCount; ++i) {
                        Row pRow = deptPerIter.getRowAtRangeIndex(i);
                        pRow.setAttribute("PersonDistributionId", null);
                        pRow.setAttribute("DistributionStatus", null);
                        pRow.setAttribute("Attribute1", "N");
                    }
                }
            } else {
                setWhereClause("DISTRIBUTION_STATUS = '预保存' AND TYPE_NAME = :1 AND DISTRIBUTION_DATE = TO_DATE(:2, 'yyyy-mm') AND ORGANIZATION_ID = :3 ");
                setWhereClauseParams(null);
                setWhereClauseParam(0, bonusType);
                setWhereClauseParam(1, distDate);
                setWhereClauseParam(2, deptOrgID);
                executeQuery();
            }
            //            System.out.println(getQuery());
        }
    }
}
